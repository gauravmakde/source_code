import os
import time
import xml.etree.ElementTree as et

from google.cloud import bigquery

import pandas as pd

datestr = time.strftime("%Y-%m-%d")
timestr = time.strftime("%Y-%m-%d-%H%M")
directory = 'reports ' + datestr

if not os.path.exists(directory):
    os.mkdir(directory)

# tree = et.parse("C://Users//Gaurav.Makde//PycharmProjects//pythonProject//reports 2024-02-01//XML_read_input_file.xml")

# sql='''
# SELECT distinct * FROM `dmgcp-del-147.cisco_project.n_level_lineage_finlglvwdb_part_1_2_3`
# where lower(BaseObject) = 'n_customer_bllng_dispute_srce' and wf_name not like '%_CG1_%' and wf_folder != 'EDWTD_BATCH_ACCUM' and TargetName NOT IN ("el_fnd_lookup_values","st_cg1_fnd_lookup_values","ex_cg1_mtl_transaction_acc","st_om_fnd_lookup_values_saf","ev_op_unit_gaap_company","el_fnd_user","st_om_fnd_lookup_values","el_ood_org_sob_company","st_cg_fnd_lookup_values_ar","st_mf_fnd_lookup_values","st_cg1_mtl_transaction_acc","el_ood_order_headers_all","calendar","sm_material_transaction","st_cts_fnd_user","w_material_transaction_detail","pst_cloud_mtl_transaction_acc","st_cloud_mtl_transaction_acc","calendartmp","cg1_fnd_lookup_values","st_mf_fnd_user","el_gl_code_combinations","st_ood_fusn_order_headers_all","st_cg1_fnd_user","st_cdc_fnd_lookup_values_ar","el_cg1_enabled_org","cg1_mtl_transaction_accounts","st_cloud_fnd_lookup_values","ev_n_general_ledger_account","ex_material_transaction","st_cg1_gl_code_combinations","pst_cloud_fnd_lookup_values","el_cbm_products","st_mf_gl_code_combinations","cdc_fnd_lookup_values","st_cloud_mtl_material_transact","calbasics","st_cg1_mtl_material_transacti","el_cst_cost_elements","el_cg1_xxgco_oe_ord_lines_ext","w_material_transaction","cg1_mtl_system_items_b","pst_cbm_inv_id_mapping","st_cloud_gl_code_combinations","stg_cg1_mtl_trans_accounts","stg_cg1_fnd_lookup_values","cg1_mtl_material_transacti","st_cg1_cst_cost_elements","pst_cloud_mtl_material_transact","el_mtl_transaction_reas","gg_cg1_wip_flow_schedules","pst_cloud_gl_code_combinations","stg_cdc_fnd_lookup_values","stg_cg1_mtl_material_transact","st_cg1_xxgco_oe_order_lines","cg1_wip_flow_schedules","st_cloud_cst_cost_elements","st_cg1_mtl_transaction_reas","stg_cg1_mtl_system_items_b","gg_cg1_oe_order_lines_all","cg1_oe_order_lines_all","pst_cloud_cst_cost_elements","cg1_xxgco_oe_ord_ln_e","st_cloud_mtl_transaction_reas","stg_cg1_oe_order_lines_all","stg_cg1_wip_flow_schedules","stg_cg1_xxgco_oe_ord_ln_e","pst_cloud_mtl_transaction_reas") and wf_name not in ("wf_ST_CDC_RA_CUST_TRX_TYPES","wf_ST_CDC_AR_RECEIVABLE_TRX_ALL","wf_ST_CDC_XXICM_SAF_HEADERS","wf_ST_CDC_AR_PYMNT_TERM","wf_ST_CDC_RA_BATCH_SOURCES_ALL","wf_ST_CDC_AR_ADJUSTMENTS","wf_ST_CDC_RA_CUSTOMER_TRX","wf_ST_CDC_FND_LOOKUP_VALUES_AR","wf_ST_CDC_AR_RECV_APPLICATIONS","wf_ST_CDC_AR_CASH_RECEIPTS","wf_ST_CDC_GL_CODE_COMBINATIONS","wf_EL_CDC_GL_CODE_COMBINATIONS","wf_ST_SHR_EMPLOYEES","wf_ST_SHR_NON_EMPLOYEES","wf_ST_SHR_MASTER_VERSIONS_V_CONFIRMED","wf_ST_SHR_STRUCT_INTERFACE_V_CONFIRMED","null","wf_EL_SALES_REP","wf_W_SALES_TERRITORY","wf_EL_SALES_TERRITORY","wf_EL_SALES_CREDIT_TYPES","wf_EL_CDC_MTL_SYSTEM_ITEMS_B","wf_ST_CDC_FND_APPLICATION_TL_AR","wf_N_PARTNER_LED_HIER_SALES_TERR","wf_ST_CDC_MTL_SYSTEM_ITEMS_B","wf_ST_SHR_MASTER_VERSIONS_V","wf_ST_SHR_STRUCT_INTERFACE_V","wf_ST_CDC_RA_RULES","wf_MT_ERP_SALES_REP","wf_ST_CDC_RA_CUST_TRX_LINES")
# and wf_name in ("wf_ST_SI_ACCOUNT_TYPE","wf_ST_ET_ACCOUNT_BUCKETS","wf_WK_FINANCIAL_ACCT_HIER_NODE","wf_EL_ET_EXPENSE_ACCOUNTS_SRC2EL","wf_WK_FINANCIAL_ACCOUNT","wf_ST_SI_ACCOUNT_INFO","wf_N_FINANCIAL_ACCT_HIER_NODE_TV","wf_EL_SI_ACCOUNT_TYPE","wf_EL_ET_ACCOUNT_BUCKETS","wf_ST_CAP_ACCOUNTS","wf_WK_FINANCIAL_SUBACCOUNT","wf_ST_CLOUD_MTL_TRANSACTION_REAS_PRE","wf_WK_LOCAL_FINANCIAL_ACCT","wf_N_FINANCIAL_ACCOUNT_TV","wf_ST_SI_ACCOUNT_LOCAL","wf_N_FINANCIAL_SUBACCOUNT_TV","wf_ST_CLOUD_CST_COST_ELEMENTS_PRE","wf_ST_CLOUD_MTL_TRANSACTION_REAS","wf_N_LOCAL_FINANCIAL_ACCT_TV","wf_ST_SI_FLEX_VALUE_SET_STRUCT","wf_ST_SI_SUB_ACCOUNT_INFO","wf_ST_CLOUD_COST_ELEMENTS","wf_WK_FIN_ACCT_LOCALITY","wf_WK_FIN_SUBACCT_LOCALITY","wf_EL_MTL_TRANSACTION_REAS","wf_ST_CLOUD_XLA_AE_HEADERS_PRE","wf_ST_MF_XLA_DISTRIB_LINKS","wf_WK_AR_ADJUSTMENT_TYPE","wf_ST_SI_THEATER","wf_ST_MF_FND_ID_FLEX_STRUC_TL","wf_WK_AR_TRX_TYPE","wf_N_MATERIAL_TRX_RETRO_UPDATE","wf_W_MATERIAL_TRANSACTION","wf_WK_AR_TRX_TYPE_OOD","wf_EL_CST_COST_ELEMENTS","wf_ST_CLOUD_XLA_DISTRIB_LINK","wf_ST_MF_XLA_AE_HEADERS","wf_WK_CHART_OF_ACCOUNTS","wf_ST_MF_FND_ID_FLEX_SEGMENTS","wf_ST_CLOUD_XLA_AE_HEADERS","wf_ST_CLOUD_MTL_MATERIAL_TRANSACT_PRE","wf_ST_CLOUD_GL_CODE_COMBINATIONS_PRE","wf_N_FIN_SUBACCT_LOCALITY_TV","wf_N_FIN_ACCT_LOCALITY_TV","wf_EL_XLA_DISTRIB_LINKS","wf_WK_AR_BATCH_SOURCE_OOD","wf_ST_CLOUD_GL_CODE_COMBINATIONS","wf_WK_AR_BATCH_SOURCE","wf_WK_FINANCIAL_THEATER","wf_ST_CLOUD_GL_LEDGERS_PRE","wf_EL_XLA_AE_HEADERS","wf_ST_CG_RA_BATCH_SOURCES_ALL","wf_ST_CLOUD_HR_ALL_ORG_UNITS_PRE","wf_ST_CG_AR_RECEIVABLE_TRX_ALL","wf_ST_MF_GL_CODE_COMBINATIONS","wf_EL_CBM_INV_ID_MAPPING_PRE","wf_ST_MF_FND_CURRENCIES_TL","wf_ST_CG_XXICM_SAF_HEADERS_REV","wf_ST_CG_XXICM_SAF_HEADERS","wf_ST_MF_FND_CURRENCIES","wf_ST_CG_RA_CUST_TRX_TYPES","wf_ST_MF_GL_PERIODS","wf_ST_CG_AR_PYMNT_TERM","wf_WK_AR_TRX","wf_WK_AR_TRX_OOD","wf_ST_CG_AR_RECV_APPLICATIONS","wf_ST_CLOUD_MTL_TRANSACTION_ACC","wf_ST_CLOUD_XLA_DISTRIB_LINK_PRE","wf_ST_CTS_FND_USER_R12_MERGE","wf_WK_FINANCIAL_COMPANY","wf_WK_SET_OF_BOOKS","wf_W_MATERIAL_TRANSACTION_DETAIL","wf_WK_DIRECT_CORP_ADJ_TYPE","wf_N_AR_BATCH_SOURCE_TV_OOD","wf_N_AR_BATCH_SOURCE_TV","wf_N_AR_TRX_TYPE_TV_OOD","wf_N_AR_TRX_TYPE_TV","wf_WK_ISO_CURRENCY","wf_ST_OOD_FUSN_RA_TERMS_TL","wf_EL_GL_PERIODS","wf_ST_CG_AR_ADJUSTMENTS","wf_WK_AR_CASH_RECEIPT_TRX_DETAIL","wf_ST_CLOUD_HR_ALL_ORG_UNITS","wf_ST_OM_FND_LOOKUP_VALUES_SAF","wf_ST_CG_FND_LOOKUP_VALUES_AR","wf_ST_CG_RA_CUSTOMER_TRX","wf_ST_MF_GL_LEDGER_RELATNSHPS","wf_ST_MF_GL_LEDGERS","wf_ST_MF_FND_USER","wf_ST_SI_COMPANY_INFO","wf_EL_GL_CODE_COMBINATIONS","wf_ST_OOD_FUSN_ORDER_HEADERS_ALL","wf_ST_COUNTRY_INFO","wf_ST_MF_HR_ALL_ORG_UNITS","wf_ST_CLOUD_GL_LEDGERS","wf_ST_CLOUD_XLA_AE_LINES_PRE","wf_WK_AR_ADJUSTMENT_STATUS","wf_N_AR_ADJUSTMENT_TYPE_TV","wf_N_FINANCIAL_THEATER_TV","wf_ST_CLOUD_FND_LOOKUP_VALUES_PRE","wf_ST_CG_AR_CASH_RECEIPTS","wf_N_CHART_OF_ACCOUNTS","wf_EL_AR_PAYMENT_TERM","wf_EL_OOD_AR_PAYMENT_TERM","wf_WK_AR_CASH_RECEIPT","wf_EL_AR_ADJUSTMENT_TRX","wf_WK_AR_ADJUSTMENT_TRX","wf_N_CUR_CONV_DAILY_BAL_SHEET_RT","wf_WK_CURRENCY_CONV_DAILY_RATE","wf_EL_HR_ALL_ORG_UNITS","wf_ST_OOD_FUSN_RA_CUSTOMER_TRX_ALL","wf_EL_GL_LEDGER_RELATNSHPS","wf_ST_MF_GL_DAILY_RATES","wf_N_ISO_CURRENCY_TV","wf_N_AR_ADJUSTMENT_STATUS","wf_W_CS_CUSTOMER_CONTACT_PARTY","wf_EL_COE_FND_LOOKUP_VALUES","wf_EL_FND_USER","wf_EL_OOD_RA_CUSTOMER_TRX_ALL","wf_EL_OM_XXCAC_SAF_HEADER","wf_EL_OM_XXCAC_SAF_HEADER_REV","wf_ST_OM_FND_LOOKUP_VALUES","wf_EL_OOD_ORG_SOB_COMPANY","wf_ST_CLOUD_MTL_TRANSACTION_ACC_PRE","wf_EL_AR_TRX_TYPE","wf_EL_GL_LEDGERS","wf_ST_MF_FND_LOOKUP_VALUES_DAC","wf_ST_MF_FND_LOOKUP_VALUES","wf_ST_CLOUD_MF_FND_LOOKUP_VALUES","wf_EL_OOD_ORDER_HEADERS_ALL","wf_EL_MF_FND_LOOKUP_VALUES","wf_EL_FND_LOOKUP_VALUES_CFI_ADJ_TYPE","wf_EL_OM_FND_LOOKUP_VALUES","wf_EL_MF_FND_LOOKUP_VALUES_DAC","wf_WI_AR_INITIATOR_DTL","wf_WI_AR_ADJSTMNT_INIT_DTL","wf_N_SET_OF_BOOKS_TV","wf_N_FINANCIAL_COMPANY_TV","wf_ST_PL_FX_RATE_PUBLISH","wf_N_AR_TRX","wf_N_AR_TRX_OOD","wf_N_AR_ADJUSTMENT_TRX","wf_N_AR_CASH_RECEIPT","wf_WK_CM_ADJUSTMENT_ARADJ_TRX","wf_N_CURRENCY_CONV_DAILY_RATE","wf_N_CUR_CONV_DAILY_RT_EXP_FUTURE","wf_N_AR_CASH_RECEIPT_TRX_DETAIL","wf_WK_CM_ADJUSTMENT_VENINV_DIST","wf_WK_CM_ADJUSTMENT_CSHRCPT_DTL","wf_MT_CM_ADJUSTMENT","wf_WK_AR_TRX_ITEM_LINE","wf_WK_AR_TRX_TAX_LINE","wf_WK_AR_ACCOUNTING_RULE_OOD","wf_WK_AR_TRX_ITEM_LINE_OOD","wf_N_AR_TRX_TAX_LINE_OOD","wf_ST_OOD_FUSN_RA_CUST_TRX_LINES","wf_EL_RA_RULES","wf_ST_OOD_FUSN_RA_RULES","wf_N_AR_TRX_TAX_LINE","wf_ST_OOD_FUSN_ORDER_LINES_ALL","wf_EL_OM_RA_CUSTOMER_TRX","wf_N_AR_TRX_LINE","wf_EL_OM_RA_CUST_TRX_LINES","wf_EL_OOD_ORDER_LINES_ALL","wf_EL_OOD_RA_CUST_TRX_LINES","wf_ST_CG_RA_RULES","wf_ST_CG_RA_CUST_TRX_LINES","wf_WK_AR_TRX_FREIGHT_LINE_OOD","wf_WK_AR_TRX_LINE","wf_N_AR_TRX_LINE_OOD","wf_EL_OM_RA_CUST_TRX_LN_ORD_LN","wf_WK_AR_TRX_LINE_OOD","wf_WK_AR_TRX_FREIGHT_LINE","wf_WK_AR_TRX_TAX_LINE_OOD","wf_N_AR_TRX_CR_ASGN_NON_APPLD_TRX","wf_ST_AE_ALLOCATION_HIST","wf_ST_CG_XXCFIR_REV_EXTRACT_OA_S_NRS","wf_W_AR_TRX_CR_ASGN_NON_APPLD_TRX","wf_SM_AR_TRX_CR_ASGN_NON_APPLD_TRX","wf_WI_AR_TRX_CR_ASGN_NON_APPLD_TRX","wf_ST_AE_ALLOCATION","wf_ST_OM_CSM_HDR_SC_NONAPPLD_DEL","wf_W_ACCRUED_REV_TRX","wf_W_SALES_TERR_CNFRMD","wf_EL_FND_APPLICATION_AR","wf_WI_CG_ACCRUAL_DIST_ALL","wf_ST_OM_CSM_HDR_SC_NONAPPLD","wf_EL_XXCFIR_REV_EXTRACT_OA_S","wf_ST_CG_FND_APPLICATION_TL_AR","wf_WI_INDRCT_REV_COGS_ADJ_ALLOC","wf_EL_XXCFIR_REV_EXTRACT_OA_S_NRS","wf_WI_INDRCT_REV_COGS_ADJ_ALLOC_HIST","wf_N_ACCRUED_REV_TRX","wf_N_AR_TRX_ITEM_LINE","wf_N_AR_TRX_FREIGHT_LINE","wf_N_AR_TRX_ITEM_LINE_OOD","wf_N_AR_TRX_FREIGHT_LINE_OOD","wf_ST_CG_XXCFIR_REV_EXTRACT_OA_S","wf_ST_CG_XXICM_SAF_INVOICES","wf_W_CUSTOMER_BLLNG_DISPUTE_SRCE","wf_W_CUSTOMER_BLLNG_DISPUTE_RSN","wf_N_CUSTOMER_BLLNG_DISPUTE_SRCE","wf_PST_CLOUD_XLA_AE_HEADERS","wf_N_CUSTOMER_BLLNG_DISPUTE_RSN","wf_W_FCM_DEAL_MAPPING","wf_W_CUSTOMER_BLLNG_DISPUTE_INVC","wf_N_FCM_DEAL_MAPPING","wf_ST_CG_XXICM_DISPUTE_INV","wf_PST_CLOUD_XLA_AE_LINES","wf_N_AR_POSTING_CONTROL","wf_ST_CG_XXICM_DISPUTE_HEADERS","wf_N_CUSTOMER_BILLING_DISPUTE","wf_EL_OM_XXCAC_SAF_INVOICES","wf_PST_CLOUD_XLA_DISTRIB_LINK","wf_N_CUSTOMER_BLLNG_DISPUTE_INVC","wf_WK_AR_POSTING_CONTROL","wf_N_CUSTOMER_BLLNG_DISPUTE_STS","wf_ST_FCM_DEAL_MAPPING","wf_W_CUSTOMER_BILLING_DISPUTE","wf_W_CUSTOMER_BLLNG_DISPUTE_STS","wf_W_RAE_ADJSTMNT_GL_DSTRBTN","wf_ST_NGCCRM_RAE_ADJ_LINE_DTLS","wf_W_RAE_ADJUSTMENT_SCHDL_LINE","wf_W_RAE_ADJSTMNT_GL_DSTRBTN_RAO","wf_W_RAE_ADJUSTMENT_SCHDL_LINE_RAO","wf_N_RAE_ADJSTMNT_GL_DSTRBTN","wf_N_RAE_ADJUSTMENT_SCHDL_LINE","wf_EL_AR_LEDGER","wf_EL_OM_XXCAC_SAF_LINES_DISTRI","wf_N_SPECIAL_CONDITION_SAF","wf_N_SPECIAL_CONDITION_SAF_LINE","wf_W_SPECIAL_CONDITION_SAF","wf_W_SPECIAL_CONDITION_SAF_LINE","wf_ST_CG_XXICM_SAF_LINE_DISTRI","wf_ST_CG_XXICM_SAF_LINES")
#
# '''
# client=bigquery.Client('dmgcp-del-147')
# df=client.query(sql).to_dataframe()
# exit()
df = pd.read_csv(directory+"\\n_customer_billing_dispute.csv")

distinct_level=sorted(df['level'].unique())

final_df=pd.DataFrame()
count=1
for df_level in distinct_level:

    if count==df_level:
        df_level = [df_level]
        mask = df['level'].isin(df_level)
        active_customers = df[mask]
        # print(len(active_customers))
        imp_columns=active_customers[['TargetSchema','TargetName','SourceSchema','SourceName','wf_name','level']].sort_values(by=['TargetSchema','TargetName'])
        # newdf=imp_columns.merge(df_worflow,how='left',on='wf_name')
        # final_df = pd.concat([final_df, newdf], axis=1)
        # print(newdf)
        final_df = pd.concat([final_df, imp_columns], axis=1)
        print(final_df)
        count+=1
    else:
        break


final_df.to_csv(directory + "\\3NF_Linage_n_ar_posting_control_lineage_" + timestr + ".csv")
