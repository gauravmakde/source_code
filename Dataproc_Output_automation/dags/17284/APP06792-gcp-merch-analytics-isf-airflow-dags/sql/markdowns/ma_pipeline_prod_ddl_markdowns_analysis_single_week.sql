DROP TABLE IF EXISTS `{{params.gcp_project_id}}`.{{params.environment_schema}}.markdowns_analysis_single_week{{params.env_suffix}};


CREATE or replace TABLE  `{{params.gcp_project_id}}`.{{params.environment_schema}}.markdowns_analysis_single_week{{params.env_suffix}} (
snapshot_date DATE NOT NULL,
channel_country STRING NOT NULL,
channel_brand STRING NOT NULL,
banner_code STRING,
selling_channel STRING,
cc STRING,
banner_channel_cc STRING,
country_banner_channel_cc STRING,
cc_dsci STRING,
div_num INTEGER,
div_label STRING,
subdiv_num INTEGER,
subdiv_label STRING,
dept_num INTEGER,
dept_label STRING,
class_num INTEGER,
class_label STRING,
subclass_num INTEGER,
subclass_label STRING,
style_group_num STRING,
rms_style_num STRING,
color_num STRING,
vpn STRING,
supp_color STRING,
style_desc STRING,
prmy_supp_num STRING,
vendor_name STRING,
vendor_label_name STRING,
npg_ind STRING,
quantrix_category STRING,
quantrix_category_group STRING,
quantrix_season STRING,
anchor_brand_ind STRING,
promotion_ind STRING,
anniversary_item_ind STRING,
replenishment_eligible_ind STRING,
drop_ship_eligible_ind STRING,
return_disposition_code STRING,
first_rack_date DATE,
rack_ind STRING,
online_purchasable_ind STRING,
online_purchasable_eff_begin_date DATE,
online_purchasable_eff_end_date DATE,
selling_status_code_legacy STRING,
selling_status_code STRING,
selling_rights_ind STRING,
average_unit_cost NUMERIC(18,2),
price_base NUMERIC(18,2),
price_ownership NUMERIC(18,2),
price_ownership_future NUMERIC(18,2),
price_selling NUMERIC(18,2),
price_band_base STRING,
price_band_ownership STRING,
price_band_ownership_future STRING,
price_band_selling STRING,
price_base_drop_ship NUMERIC(18,2),
price_compare_at NUMERIC(18,2),
price_current_rack NUMERIC(18,2),
price_variance_within_cc_ind STRING,
pct_off_ownership_vs_base NUMERIC(18,2),
pct_off_selling_vs_base NUMERIC(18,2),
pct_off_ownership_future_vs_base NUMERIC(18,2),
pct_off_ownership_vs_compare_at NUMERIC(18,2),
pct_off_ownership_future_vs_compare_at NUMERIC(18,2),
pct_off_band_ownership_vs_base STRING,
pct_off_band_selling_vs_base STRING,
pct_off_band_ownership_future_vs_base STRING,
pct_off_band_ownership_vs_compare_at STRING,
pct_off_band_ownership_future_vs_compare_at STRING,
price_type_code_ownership STRING,
price_type_code_ownership_future STRING,
price_type_code_selling STRING,
price_type_ownership STRING,
price_type_ownership_future STRING,
price_type_selling STRING,
price_signal STRING,
price_signal_future STRING,
markdown_type_ownership STRING,
markdown_type_ownership_future STRING,
lifecycle_phase_name_ownership STRING,
lifecycle_phase_name_ownership_future STRING,
first_clearance_markdown_date DATE,
last_clearance_markdown_date DATE,
future_clearance_markdown_date DATE,
clearance_markdown_version INTEGER,
future_markdown_ind STRING,
weeks_since_last_markdown INTEGER,
first_receipt_date DATE,
last_receipt_date DATE,
weeks_since_last_receipt_date INTEGER,
weeks_since_last_receipt_date_band STRING,
weeks_available_to_sell INTEGER,
weeks_available_to_sell_band STRING,
first_sales_date DATE,
weeks_since_first_sale INTEGER,
weeks_since_first_sale_band STRING,
intent_plan_week_idnt INTEGER,
intent_exit_month_idnt INTEGER,
intent_season STRING,
intent_lifecycle_type STRING,
intent_scaled_event STRING,
intent_holiday_or_celebration STRING,
sales_retail_1wk NUMERIC(18,2),
sales_units_1wk NUMERIC(18,2),
sales_retail_2wk NUMERIC(18,2),
sales_units_2wk NUMERIC(18,2),
sales_retail_4wk NUMERIC(18,2),
sales_units_4wk NUMERIC(18,2),
sales_retail_6mo NUMERIC(18,2),
sales_units_6mo NUMERIC(18,2),
sell_thru_4wk NUMERIC(18,2),
sell_thru_since_last_markdown NUMERIC(18,2),
sell_thru_4wk_avg_wkly NUMERIC(18,4),
sell_thru_band_4wk_avg_wkly STRING,
sell_thru_since_last_markdown_avg_wkly NUMERIC(18,4),
sell_thru_band_since_last_markdown_avg_wkly STRING,
eop_units_selling_locations INTEGER,
eop_retail_selling_locations NUMERIC(18,2),
eop_cost_selling_locations NUMERIC(18,2),
eop_retail_future_selling_locations NUMERIC(18,2),
eop_units_reserve_stock INTEGER,
eop_retail_reserve_stock NUMERIC(18,2),
eop_cost_reserve_stock NUMERIC(18,2),
eop_retail_future_reserve_stock NUMERIC(18,2),
eop_units_pack_and_hold INTEGER,
eop_retail_pack_and_hold NUMERIC(18,2),
eop_cost_pack_and_hold NUMERIC(18,2),
eop_retail_future_pack_and_hold NUMERIC(18,2),
eop_units_all_locations INTEGER,
eop_retail_all_locations NUMERIC(18,2),
eop_cost_all_locations NUMERIC(18,2),
eop_retail_future_all_locations NUMERIC(18,2),
on_order_units_selling_locations INTEGER,
on_order_units_reserve_stock INTEGER,
on_order_units_pack_and_hold INTEGER,
on_order_units_all_locations INTEGER,
markdown_dollars_selling_locations NUMERIC(18,2),
markdown_dollars_reserve_stock NUMERIC(18,2),
markdown_dollars_pack_and_hold NUMERIC(18,2),
markdown_dollars_all_locations NUMERIC(18,2),
markdown_dollars_future_selling_locations NUMERIC(18,2),
markdown_dollars_future_reserve_stock NUMERIC(18,2),
markdown_dollars_future_pack_and_hold NUMERIC(18,2),
markdown_dollars_future_all_locations NUMERIC(18,2),
drop_ship_eligible_ind_other_banner STRING,
replenishment_eligible_ind_other_banner STRING,
price_type_ownership_other_banner STRING,
price_type_ownership_future_other_banner STRING,
price_type_selling_other_banner STRING,
price_base_other_banner NUMERIC(18,2),
price_ownership_other_banner NUMERIC(18,2),
price_ownership_future_other_banner NUMERIC(18,2),
price_selling_other_banner NUMERIC(18,2),
future_clearance_markdown_date_other_banner DATE,
future_markdown_ind_other_banner STRING,
sell_thru_4wk_other_banner NUMERIC(18,2),
sell_thru_since_last_markdown_other_banner NUMERIC(18,2),
sell_thru_4wk_avg_wkly_other_banner NUMERIC(18,4),
sell_thru_band_4wk_avg_wkly_other_banner STRING,
sell_thru_since_last_markdown_avg_wkly_other_banner NUMERIC(18,4),
sell_thru_band_since_last_markdown_avg_wkly_other_banner STRING,
eop_units_selling_locations_other_banner INTEGER,
eop_retail_selling_locations_other_banner NUMERIC(18,2),
eop_cost_selling_locations_other_banner NUMERIC(18,2),
eop_units_all_locations_other_banner INTEGER,
eop_retail_all_locations_other_banner NUMERIC(18,2),
eop_cost_all_locations_other_banner NUMERIC(18,2),
future_clearance_markdown_date_prior_week DATE,
price_ownership_future_prior_week NUMERIC(18,2),
price_ownership_prior_week NUMERIC(18,2),
eop_units_selling_locations_prior_week INTEGER,
dw_sys_load_tmstp TIMESTAMP
)
PARTITION BY snapshot_date;


--collect stats    column ( snapshot_date, banner_channel_cc )    ,column( banner_channel_cc )    ,column( snapshot_date )    ,column( channel_brand )    ,column( selling_channel )    ,column( snapshot_date, channel_brand )    ,column( snapshot_date, selling_channel )    ,column( snapshot_date, cc)    ,column( snapshot_date, selling_channel, cc )    ,column( snapshot_date, channel_brand, cc )    ,column( cc )    ,column( selling_channel, cc )    ,column( channel_brand, cc )    ,column( snapshot_date, selling_channel, channel_brand, cc ) on {{params.environment_schema}}.markdowns_analysis_single_week{{params.env_suffix}} 