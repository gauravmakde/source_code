- subject: PURCHASE_ORDER_LIFECYCLE
  metric_name: napdw.stg_distinct_count
  sql: "select job_name, subj_area, src_db_name, src_tb_name, 'src', coalesce(src_metric, 0)
        from {DBENV}_NAP_BASE_VWS.DQ_AUDIT_LOG
        where job_name = 'PURCHASE_ORDER_SHIPMENT_DISCREPANCY_LDG_TO_BASE'
        and dw_batch_id in (select batch_id from {DBENV}_NAP_BASE_VWS.ELT_CONTROL where subject_area_nm = 'NAP_ASCP_PURCHASE_ORDER_SHIPMENT_DISCREPANCY')"
  metric_value_position: 5
  tags:
    - job_name: 0
    - subject_area: 1
    - db_name: 2
    - tbl_name: 3
    - type: 4

- subject: PURCHASE_ORDER_LIFECYCLE
  metric_name: napdw.base_distinct_count
  sql: "select job_name, subj_area, tgt_db_name, tgt_tb_name, 'tgt', coalesce(tgt_metric, 0)
        from {DBENV}_NAP_BASE_VWS.DQ_AUDIT_LOG
        where job_name = 'PURCHASE_ORDER_SHIPMENT_DISCREPANCY_LDG_TO_BASE'
        and dw_batch_id in (select batch_id from {DBENV}_NAP_BASE_VWS.ELT_CONTROL where subject_area_nm = 'NAP_ASCP_PURCHASE_ORDER_SHIPMENT_DISCREPANCY')"
  metric_value_position: 5
  tags:
    - job_name: 0
    - subject_area: 1
    - db_name: 2
    - tbl_name: 3
    - type: 4





- subject: PURCHASE_ORDER_LIFECYCLE
  metric_name: spark_processed_messages
  sql: "select 
           ISF_DAG_NM,
           CAST(ISF_DAG_START_TMSTP as VARCHAR(19)),
           CAST(ISF_DAG_END_TMSTP as VARCHAR(19)),
           CAST(SPARK_JOB_START_TMSTP as VARCHAR(19)),
           CAST(SPARK_JOB_END_TMSTP as VARCHAR(19)),
           CAST(TERADATA_JOB_START_TMSTP as VARCHAR(19)),
           CAST(TERADATA_JOB_END_TMSTP as VARCHAR(19)),
           CAST(SPARK_PROCESSED_MESSAGE_CNT as INTEGER)
        from 
         (
           select ISF_DAG_NM, BATCH_ID, METRIC_NM, METRIC_VALUE 
           from {DBENV}_NAP_BASE_VWS.ISF_DAG_CONTROL_LOG 
           where isf_dag_nm = 'po_discrepancy_lifecycle_kafka_to_orc_td_16780_TECH_SC_NAP_insights'
           and METRIC_NM not in ('TERADATA_JOB_END_TMSTP')
           and batch_id = (SELECT BATCH_ID FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE SUBJECT_AREA_NM ='NAP_ASCP_PURCHASE_ORDER_SHIPMENT_DISCREPANCY')
           union all 
           select ISF_DAG_NM, BATCH_ID, METRIC_NM, MAX(METRIC_VALUE) as METRIC_VALUE 
           from {DBENV}_NAP_BASE_VWS.ISF_DAG_CONTROL_LOG 
           where isf_dag_nm = 'po_discrepancy_lifecycle_kafka_to_orc_td_16780_TECH_SC_NAP_insights'
           and METRIC_NM in ('TERADATA_JOB_END_TMSTP')
           and batch_id = (SELECT BATCH_ID FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE SUBJECT_AREA_NM ='NAP_ASCP_PURCHASE_ORDER_SHIPMENT_DISCREPANCY')
           group by ISF_DAG_NM, BATCH_ID, METRIC_NM
        ) src 
        PIVOT (min(METRIC_VALUE) FOR METRIC_NM in ('SPARK_PROCESSED_MESSAGE_CNT' as SPARK_PROCESSED_MESSAGE_CNT , 
                                                   'ISF_DAG_START_TMSTP' as ISF_DAG_START_TMSTP , 
                                                   'ISF_DAG_END_TMSTP' as ISF_DAG_END_TMSTP,
                                                   'TERADATA_JOB_START_TMSTP' as TERADATA_JOB_START_TMSTP,
                                                   'TERADATA_JOB_END_TMSTP' as TERADATA_JOB_END_TMSTP,
                                                   'SPARK_JOB_START_TMSTP' as SPARK_JOB_START_TMSTP,
                                                   'SPARK_JOB_END_TMSTP' as SPARK_JOB_END_TMSTP
                                                  )
        ) metrics"
  metric_value_position: 7
  tags:
    - isf_dag_nm: 0
    - isf_dag_start_tmstp: 1
    - isf_dag_end_tmstp: 2
    - spark_job_start_tmstp: 3
    - spark_job_end_tmstp: 4
    - teradata_job_start_tmstp: 5
    - teradata_job_end_tmstp: 6





- subject: PURCHASE_ORDER_LIFECYCLE
  metric_name: ldg_loaded_cnt
  sql: "select 
           ISF_DAG_NM,
           TBL_NM,
           CAST(SPARK_JOB_END_TMSTP as VARCHAR(19)),
           CAST(LOADED_TO_LDG_CNT as INTEGER)
        from 
         (
           select ISF_DAG_NM, METRIC_NM, METRIC_VALUE, MAX(TBL_NM) OVER (PARTITION BY NULL) as TBL_NM
           from {DBENV}_NAP_BASE_VWS.ISF_DAG_CONTROL_LOG          
           where isf_dag_nm = 'po_discrepancy_lifecycle_kafka_to_orc_td_16780_TECH_SC_NAP_insights'
           and batch_id = (SELECT BATCH_ID FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE SUBJECT_AREA_NM ='NAP_ASCP_PURCHASE_ORDER_SHIPMENT_DISCREPANCY')
           and (TBL_NM = 'NAP_STG.PURCHASE_ORDER_SHIPMENT_DISCREPANCY_LDG' or metric_nm in ('ISF_DAG_START_TMSTP', 'SPARK_JOB_END_TMSTP'))
         ) src 
        PIVOT (min(METRIC_VALUE) FOR METRIC_NM in ('LOADED_TO_LDG_CNT' as LOADED_TO_LDG_CNT , 
                                                   'ISF_DAG_START_TMSTP' as ISF_DAG_START_TMSTP,
                                                   'SPARK_JOB_END_TMSTP' as SPARK_JOB_END_TMSTP
                                                  )
        ) metrics"
  metric_value_position: 3
  tags:
    - isf_dag_nm: 0
    - ldg_tbl_nm: 1
    - loading_tmstp: 2

- subject: PURCHASE_ORDER_LIFECYCLE
  metric_name: ldg_table_cnt
  sql: "select 
           'po_discrepancy_lifecycle_kafka_to_orc_td_16780_TECH_SC_NAP_insights' as ISF_DAG_NM,
           'NAP_STG.PURCHASE_ORDER_SHIPMENT_DISCREPANCY_LDG' as TBL_NM,
            (SELECT BATCH_ID FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE SUBJECT_AREA_NM ='NAP_ASCP_PURCHASE_ORDER_SHIPMENT_DISCREPANCY') as BATCH_ID,
            COUNT(*)
            from {DBENV}_NAP_STG.PURCHASE_ORDER_SHIPMENT_DISCREPANCY_LDG"
  metric_value_position: 3
  tags:
    - isf_dag_nm: 0
    - ldg_tbl_nm: 1
    - batch_id: 2
