- subject: DC_INTERNAL_TRANSFER
  metric_name: napdw.stg_distinct_count
  sql: "SELECT job_name, subj_area, src_db_name, src_tb_name,  'src', COALESCE(src_metric, 0)
 FROM {DBENV}_NAP_BASE_VWS.DQ_AUDIT_LOG
WHERE job_name='DC_INTERNAL_TRANSFER_SHIPMENT_RECEIPT_LDG_TO_BASE'
  AND dw_batch_id = (SELECT batch_id FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE subject_area_nm = 'NAP_ASCP_DC_INTERNAL_TRANSFER')"
  metric_value_position: 5
  tags:
    - job_name: 0
    - subject_area: 1
    - db_name: 2
    - tbl_name: 3
    - type: 4
- subject: DC_INTERNAL_TRANSFER
  metric_name: napdw.base_distinct_count
  sql: "SELECT job_name, subj_area, tgt_db_name, tgt_tb_name, 'tgt', COALESCE(tgt_metric, 0)
 FROM {DBENV}_NAP_BASE_VWS.DQ_AUDIT_LOG
WHERE job_name='DC_INTERNAL_TRANSFER_SHIPMENT_RECEIPT_LDG_TO_BASE'
  AND dw_batch_id = (SELECT batch_id FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE subject_area_nm = 'NAP_ASCP_DC_INTERNAL_TRANSFER')"
  metric_value_position: 5
  tags:
    - job_name: 0
    - subject_area: 1
    - db_name: 2
    - tbl_name: 3
    - type: 4

- subject: DC_INTERNAL_TRANSFER
  metric_name: spark_processed_messages
  sql: "select 
           ISF_DAG_NM,
           CAST(ISF_DAG_START_TMSTP as string),
           CAST(ISF_DAG_END_TMSTP as string),
           CAST(SPARK_JOB_START_TMSTP as string),
           CAST(SPARK_JOB_END_TMSTP as string),
           CAST(TERADATA_JOB_START_TMSTP as string),
           CAST(TERADATA_JOB_END_TMSTP as string),
           SUBSTRING(ISF_DAG_START_TMSTP,12,2),
           CAST(SPARK_PROCESSED_MESSAGE_CNT as INTEGER)
        from 
         (
           select ISF_DAG_NM, BATCH_ID, METRIC_NM, METRIC_VALUE from {DBENV}_NAP_BASE_VWS.ISF_DAG_CONTROL_LOG 
           where isf_dag_nm = 'nrlt_dc_internal_transfer_lifecycle_16753_TECH_SC_NAP_insights'
           and METRIC_NM not in ('TERADATA_JOB_END_TMSTP')
           and batch_id = (SELECT BATCH_ID FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE SUBJECT_AREA_NM ='NAP_ASCP_DC_INTERNAL_TRANSFER')
           union all 
           select ISF_DAG_NM, BATCH_ID, METRIC_NM, MAX(METRIC_VALUE) as METRIC_VALUE from {DBENV}_NAP_BASE_VWS.ISF_DAG_CONTROL_LOG 
           where isf_dag_nm = 'nrlt_dc_internal_transfer_lifecycle_16753_TECH_SC_NAP_insights'
           and METRIC_NM in ('TERADATA_JOB_END_TMSTP')
           and batch_id = (SELECT BATCH_ID FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE SUBJECT_AREA_NM ='NAP_ASCP_DC_INTERNAL_TRANSFER')
           group by ISF_DAG_NM, BATCH_ID, METRIC_NM
        ) src 
        PIVOT (min(METRIC_VALUE) FOR METRIC_NM in ('SPARK_PROCESSED_MESSAGE_CNT' as SPARK_PROCESSED_MESSAGE_CNT , 
                                                   'ISF_DAG_START_TMSTP' as ISF_DAG_START_TMSTP , 
                                                   'ISF_DAG_END_TMSTP' as ISF_DAG_END_TMSTP,
                                                   'TERADATA_JOB_START_TMSTP' as TERADATA_JOB_START_TMSTP,
                                                   'TERADATA_JOB_END_TMSTP' as TERADATA_JOB_END_TMSTP,
                                                   'SPARK_JOB_START_TMSTP' as SPARK_JOB_START_TMSTP,
                                                   'SPARK_JOB_END_TMSTP' as SPARK_JOB_END_TMSTP
                                                  )
        ) metrics"
  metric_value_position: 8
  tags:
    - isf_dag_nm: 0
    - isf_dag_start_tmstp: 1
    - isf_dag_end_tmstp: 2
    - spark_job_start_tmstp: 3
    - spark_job_end_tmstp: 4
    - teradata_job_start_tmstp: 5
    - teradata_job_end_tmstp: 6
    - execution_hour: 7

- subject: DC_INTERNAL_TRANSFER
  metric_name: ldg_loaded_cnt
  sql: "select 
           ISF_DAG_NM,
           TBL_NM,
           CAST(SPARK_JOB_END_TMSTP as string),
           SUBSTRING(ISF_DAG_START_TMSTP,12,2),
           CAST(LOADED_TO_LDG_CNT as INTEGER)
        from 
         (
           select ISF_DAG_NM, METRIC_NM, METRIC_VALUE, COALESCE(TBL_NM, '{DBENV}_NAP_STG.DC_INTERNAL_TRANSFER_SHIPMENT_RECEIPT_LDG') as TBL_NM
           from {DBENV}_NAP_BASE_VWS.ISF_DAG_CONTROL_LOG          
           where isf_dag_nm = 'nrlt_dc_internal_transfer_lifecycle_16753_TECH_SC_NAP_insights'
           and batch_id = (SELECT BATCH_ID FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE SUBJECT_AREA_NM ='NAP_ASCP_DC_INTERNAL_TRANSFER')
           and (TBL_NM = '{DBENV}_NAP_STG.DC_INTERNAL_TRANSFER_SHIPMENT_RECEIPT_LDG' or metric_nm in ('ISF_DAG_START_TMSTP', 'SPARK_JOB_END_TMSTP'))
         ) src 
        PIVOT (min(METRIC_VALUE) FOR METRIC_NM in ('LOADED_TO_LDG_CNT' as LOADED_TO_LDG_CNT , 
                                                   'ISF_DAG_START_TMSTP' as ISF_DAG_START_TMSTP,
                                                   'SPARK_JOB_END_TMSTP' as SPARK_JOB_END_TMSTP
                                                  )
        ) metrics"
  metric_value_position: 4
  tags:
    - isf_dag_nm: 0
    - ldg_tbl_nm: 1
    - loading_tmstp: 2
    - execution_hour: 3
    
- subject: DC_INTERNAL_TRANSFER
  metric_name: ldg_table_cnt
  sql: "select 
           'nrlt_dc_internal_transfer_lifecycle_16753_TECH_SC_NAP_insights' as ISF_DAG_NM,
           '{DBENV}_NAP_STG.DC_INTERNAL_TRANSFER_SHIPMENT_RECEIPT_LDG' as TBL_NM,
           (SELECT BATCH_ID FROM {DBENV}_NAP_BASE_VWS.ELT_CONTROL WHERE SUBJECT_AREA_NM ='NAP_ASCP_DC_INTERNAL_TRANSFER') as BATCH_ID,
           COUNT(*)
        from {DBENV}_NAP_BASE_VWS.DC_INTERNAL_TRANSFER_SHIPMENT_RECEIPT_LDG"
  metric_value_position: 3
  tags:
    - isf_dag_nm: 0
    - ldg_tbl_nm: 1
    - batch_id: 2
    
