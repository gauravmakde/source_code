-- mandatory Query Band part
SET QUERY_BAND = 'App_ID=app07420; DAG_ID=payment_auth_result_teradata;Task_Name=teradata_stg_to_teradata_fct_job;' -- noqa
FOR SESSION VOLATILE;

END TRANSACTION;

-- Create temporary tables for selecting distinct records by 'settlementID'.
CREATE MULTISET VOLATILE TABLE TEMP_PAYMENT_AUTHORIZATION_RESULT_STG AS (
    SELECT DISTINCT *
    FROM {db_env}_NAP_STG.PAYMENT_AUTHORIZATION_RESULT_LDG
    QUALIFY
        row_number() OVER (
            PARTITION BY
                AUTHORIZATION_RESULT_ID
            ORDER BY TRANSACTION_TIMESTAMP DESC
        ) = 1
) WITH DATA PRIMARY INDEX (AUTHORIZATION_RESULT_ID) ON COMMIT PRESERVE ROWS;

END TRANSACTION;

-- Insert or update if exist
MERGE INTO {db_env}_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT AS PSR
USING TEMP_PAYMENT_AUTHORIZATION_RESULT_STG AS SRC
    ON (
        SRC.AUTHORIZATION_RESULT_ID = PSR.AUTHORIZATION_RESULT_ID
        AND cast(
            concat(SRC.TRANSACTION_TIMESTAMP, '+00:00') AS TIMESTAMP(6) WITH TIME ZONE
        ) = PSR.TRANSACTION_TIMESTAMP
    )
WHEN MATCHED THEN
    UPDATE
        SET
            DW_SYS_UPDT_TMSTP = current_timestamp(0),
            CHANNEL_COUNTRY = SRC.CHANNEL_COUNTRY,
            CHANNEL_BRAND = SRC.CHANNEL_BRAND,
            SELLING_CHANNEL = SRC.SELLING_CHANNEL,
            ACQUIRER = SRC.ACQUIRER,
            AUTHORIZATION_AMOUNT_CURRENCY_CODE
            = SRC.AUTHORIZATION_AMOUNT_CURRENCY_CODE,
            AUTHORIZATION_AMOUNT = SRC.AUTHORIZATION_AMOUNT,
            STORE_NUMBER = SRC.STORE_NUMBER,
            PROCESSING_DATE = SRC.PROCESSING_DATE,
            TENDER_TYPE = SRC.TENDER_TYPE,
            TRANSACTION_TIME_ZONE_OFFSET_MINUTES
            = SRC.TRANSACTION_TIME_ZONE_OFFSET_MINUTES
WHEN NOT MATCHED THEN
    INSERT (
        DW_SYS_LOAD_TMSTP,
        DW_SYS_UPDT_TMSTP,
        CHANNEL_COUNTRY,
        CHANNEL_BRAND,
        SELLING_CHANNEL,
        ACQUIRER,
        AUTHORIZATION_AMOUNT_CURRENCY_CODE,
        AUTHORIZATION_AMOUNT,
        AUTHORIZATION_RESULT_ID,
        STORE_NUMBER,
        PROCESSING_DATE,
        TENDER_TYPE,
        TRANSACTION_TIMESTAMP,
        TRANSACTION_TIME_ZONE_OFFSET_MINUTES
    )
        VALUES (
            current_timestamp(0),
            current_timestamp(0),
            SRC.CHANNEL_COUNTRY,
            SRC.CHANNEL_BRAND,
            SRC.SELLING_CHANNEL,
            SRC.ACQUIRER,
            SRC.AUTHORIZATION_AMOUNT_CURRENCY_CODE,
            SRC.AUTHORIZATION_AMOUNT,
            SRC.AUTHORIZATION_RESULT_ID,
            SRC.STORE_NUMBER,
            SRC.PROCESSING_DATE,
            SRC.TENDER_TYPE,
            cast(
                concat(
                    SRC.TRANSACTION_TIMESTAMP, '+00:00'
                ) AS TIMESTAMP(6) WITH TIME ZONE
            ),
            SRC.TRANSACTION_TIME_ZONE_OFFSET_MINUTES
        );

MERGE INTO {db_env}_NAP_BASE_VWS.PAYMENT_BANK_CARD_AUTHORIZATION_RESULT_FACT AS PBC
USING TEMP_PAYMENT_AUTHORIZATION_RESULT_STG AS SRC
    ON (SRC.AUTHORIZATION_RESULT_ID = PBC.AUTHORIZATION_RESULT_ID)
WHEN MATCHED THEN
    UPDATE
        SET
            DW_SYS_UPDT_TMSTP = current_timestamp(0),
            ACQUIRER_MERCHANT_IDENTIFIER = SRC.ACQUIRER_MERCHANT_IDENTIFIER,
            AUTHORIZATION_TYPE = SRC.AUTHORIZATION_TYPE,
            CARD_TYPE = SRC.CARD_TYPE,
            CARD_SUBTYPE = SRC.CARD_SUBTYPE,
            ENTRY_MODE = SRC.ENTRY_MODE,
            MERCHANT_CATEGORY_CODE = SRC.MERCHANT_CATEGORY_CODE,
            TOKEN_VALUE = SRC.TOKEN_VALUE,
            TOKEN_AUTHORITY = SRC.TOKEN_AUTHORITY,
            TOKEN_DATA_CLASSIFICATION = SRC.TOKEN_DATA_CLASSIFICATION,
            TOKEN_TYPE = SRC.TOKEN_TYPE,
            BANK_CARD_AUTHORIZATION_SOURCE = SRC.BANK_CARD_AUTHORIZATION_SOURCE,
            EXPIRATION_DATE_MONTH = SRC.EXPIRATION_DATE_MONTH,
            EXPIRATION_DATE_YEAR = cast(
                to_number(
                    from_bytes(SRC.EXPIRATION_DATE_YEAR, 'ASCII')
                ) AS SMALLINT
            ),
            AUTHORIZATION_CODE = SRC.AUTHORIZATION_CODE,
            CREDIT_RESPONSE_CODE = SRC.CREDIT_RESPONSE_CODE,
            CREDIT_RESPONSE_CATEGORY = SRC.CREDIT_RESPONSE_CATEGORY,
            ADDRESS_VERIFICATION_RESPONSE_CODE
            = SRC.ADDRESS_VERIFICATION_RESPONSE_CODE,
            AUTHORIZATION_SERVICE_INDICATOR
            = SRC.AUTHORIZATION_SERVICE_INDICATOR,
            CVV_TWO_PRESENCE_INDICATOR = SRC.CVV_TWO_PRESENCE_INDICATOR,
            CVV_TWO_RESPONSE_INDICATOR = SRC.CVV_TWO_RESPONSE_INDICATOR,
            MAIL_PHONE_INDICATOR = SRC.MAIL_PHONE_INDICATOR,
            VENDOR_AUTHORIZATION_SYSTEM = SRC.VENDOR_AUTHORIZATION_SYSTEM,
            MASTERCARD_BANKNET_REFERENCE_NUMBER
            = SRC.MASTERCARD_BANKNET_REFERENCE_NUMBER,
            MASTERCARD_BANKNET_SETTLEMENT_DATE
            = SRC.MASTERCARD_BANKNET_SETTLEMENT_DATE,
            VISA_TRANSACTION_ID = SRC.VISA_TRANSACTION_ID,
            VISA_VALIDATION_CODE = SRC.VISA_VALIDATION_CODE,
            VISA_AUTHORIZATION_RESPONSE_CODE
            = SRC.VISA_AUTHORIZATION_RESPONSE_CODE,
            DEBIT_RESPONSE_CODE = SRC.DEBIT_RESPONSE_CODE,
            DEBIT_RESPONSE_CATEGORY = SRC.DEBIT_RESPONSE_CATEGORY
WHEN NOT MATCHED THEN
    INSERT (
        DW_SYS_LOAD_TMSTP,
        DW_SYS_UPDT_TMSTP,
        AUTHORIZATION_RESULT_ID,
        ACQUIRER_MERCHANT_IDENTIFIER,
        AUTHORIZATION_TYPE,
        CARD_TYPE,
        CARD_SUBTYPE,
        ENTRY_MODE,
        MERCHANT_CATEGORY_CODE,
        TOKEN_VALUE,
        TOKEN_AUTHORITY,
        TOKEN_DATA_CLASSIFICATION,
        TOKEN_TYPE,
        BANK_CARD_AUTHORIZATION_SOURCE,
        EXPIRATION_DATE_MONTH,
        EXPIRATION_DATE_YEAR,
        AUTHORIZATION_CODE,
        CREDIT_RESPONSE_CODE,
        CREDIT_RESPONSE_CATEGORY,
        ADDRESS_VERIFICATION_RESPONSE_CODE,
        AUTHORIZATION_SERVICE_INDICATOR,
        CVV_TWO_PRESENCE_INDICATOR,
        CVV_TWO_RESPONSE_INDICATOR,
        MAIL_PHONE_INDICATOR,
        VENDOR_AUTHORIZATION_SYSTEM,
        MASTERCARD_BANKNET_REFERENCE_NUMBER,
        MASTERCARD_BANKNET_SETTLEMENT_DATE,
        VISA_TRANSACTION_ID,
        VISA_VALIDATION_CODE,
        VISA_AUTHORIZATION_RESPONSE_CODE,
        DEBIT_RESPONSE_CODE,
        DEBIT_RESPONSE_CATEGORY
    )
        VALUES (
            current_timestamp(0),
            current_timestamp(0),
            SRC.AUTHORIZATION_RESULT_ID,
            SRC.ACQUIRER_MERCHANT_IDENTIFIER,
            SRC.AUTHORIZATION_TYPE,
            SRC.CARD_TYPE,
            SRC.CARD_SUBTYPE,
            SRC.ENTRY_MODE,
            SRC.MERCHANT_CATEGORY_CODE,
            SRC.TOKEN_VALUE,
            SRC.TOKEN_AUTHORITY,
            SRC.TOKEN_DATA_CLASSIFICATION,
            SRC.TOKEN_TYPE,
            SRC.BANK_CARD_AUTHORIZATION_SOURCE,
            SRC.EXPIRATION_DATE_MONTH,
            cast(
                to_number(
                    from_bytes(SRC.EXPIRATION_DATE_YEAR, 'ASCII')
                ) AS SMALLINT
            ),
            SRC.AUTHORIZATION_CODE,
            SRC.CREDIT_RESPONSE_CODE,
            SRC.CREDIT_RESPONSE_CATEGORY,
            SRC.ADDRESS_VERIFICATION_RESPONSE_CODE,
            SRC.AUTHORIZATION_SERVICE_INDICATOR,
            SRC.CVV_TWO_PRESENCE_INDICATOR,
            SRC.CVV_TWO_RESPONSE_INDICATOR,
            SRC.MAIL_PHONE_INDICATOR,
            SRC.VENDOR_AUTHORIZATION_SYSTEM,
            SRC.MASTERCARD_BANKNET_REFERENCE_NUMBER,
            SRC.MASTERCARD_BANKNET_SETTLEMENT_DATE,
            SRC.VISA_TRANSACTION_ID,
            SRC.VISA_VALIDATION_CODE,
            SRC.VISA_AUTHORIZATION_RESPONSE_CODE,
            SRC.DEBIT_RESPONSE_CODE,
            SRC.DEBIT_RESPONSE_CATEGORY
        );

-- Update PAYMENT_ID_AUTHORIZATION column
UPDATE {db_env}_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT
FROM (
SELECT
    A.AUTHORIZATION_RESULT_ID,
    B.AUTHORIZATION_CODE,
    B.TOKEN_VALUE,
    A.AUTHORIZATION_AMOUNT
FROM {db_env}_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT A
INNER JOIN {db_env}_NAP_BASE_VWS.PAYMENT_BANK_CARD_AUTHORIZATION_RESULT_FACT B
ON A.AUTHORIZATION_RESULT_ID = B.AUTHORIZATION_RESULT_ID
WHERE A.AUTHORIZATION_RESULT_ID IN
(SELECT DISTINCT AUTHORIZATION_RESULT_ID
    FROM {db_env}_NAP_STG.PAYMENT_AUTHORIZATION_RESULT_LDG)
) AS C
SET PAYMENT_ID_AUTHORIZATION = hash_sha256(concat(
                coalesce(trim(C.AUTHORIZATION_CODE), ''),
                coalesce(trim(C.TOKEN_VALUE), ''),
                coalesce(trim(cast(cast(C.AUTHORIZATION_AMOUNT AS DECIMAL(12, 2)) AS VARCHAR(50))), '')
                ))
WHERE {db_env}_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT.AUTHORIZATION_RESULT_ID = C.AUTHORIZATION_RESULT_ID;

-- Update PAYMENT_ID_SETTLEMENT_RESULT column
UPDATE {db_env}_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT
FROM (
SELECT
    A.AUTHORIZATION_RESULT_ID,
    A.TENDER_TYPE,
    A.STORE_NUMBER,
    B.TOKEN_VALUE,
    B.ACQUIRER_MERCHANT_IDENTIFIER,
    A.TRANSACTION_TIMESTAMP,
    B.CARD_TYPE
FROM {db_env}_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT A
INNER JOIN {db_env}_NAP_BASE_VWS.PAYMENT_BANK_CARD_AUTHORIZATION_RESULT_FACT B
ON A.AUTHORIZATION_RESULT_ID = B.AUTHORIZATION_RESULT_ID
WHERE A.AUTHORIZATION_RESULT_ID IN
(SELECT DISTINCT AUTHORIZATION_RESULT_ID
    FROM {db_env}_NAP_STG.PAYMENT_AUTHORIZATION_RESULT_LDG)
) AS C
SET PAYMENT_ID_SETTLEMENT_RESULT = hash_sha256(concat(
                coalesce(trim(C.TENDER_TYPE), ''),
                coalesce(trim(C.STORE_NUMBER), ''),
                coalesce(trim(C.TOKEN_VALUE), ''),
                coalesce(trim(C.ACQUIRER_MERCHANT_IDENTIFIER), ''),
                coalesce(trim(to_char(C.TRANSACTION_TIMESTAMP)), ''),
                coalesce(trim(C.CARD_TYPE), '')
                ))
WHERE {db_env}_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT.AUTHORIZATION_RESULT_ID = C.AUTHORIZATION_RESULT_ID;

-- Remove records from temporary tables
DELETE FROM {db_env}_NAP_STG.PAYMENT_AUTHORIZATION_RESULT_LDG;

SET QUERY_BAND = NONE FOR SESSION; -- noqa

END TRANSACTION;
