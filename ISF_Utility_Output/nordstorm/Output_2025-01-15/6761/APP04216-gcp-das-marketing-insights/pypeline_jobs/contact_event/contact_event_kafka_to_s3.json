{
    "dag_id": "contact_event_kafka_to_s3",
    "dag_schedule": "00 01 * * *",
    "dag_sla_minutes": "120",
    "prod_email_on_failure": "nap-marketing@nordstrom.pagerduty.com",
    "nonprod_email_on_failure": "oleksii.huts@nordstrom.com",
    "stages": [
        "load_event_bounced_object_model",
        "load_event_clicked_object_model",
        "load_event_opened_object_model",
        "load_event_sent_object_model",
        "load_event_unsubscribed_object_model",
        "extracted_and_audit_files_copy"
    ],
    "stage_dependencies": {
        "load_event_bounced_object_model": [
            "extracted_and_audit_files_copy"
        ],
        "load_event_clicked_object_model": [
            "extracted_and_audit_files_copy"
        ],
        "load_event_opened_object_model": [
            "extracted_and_audit_files_copy"
        ],
        "load_event_sent_object_model": [
            "extracted_and_audit_files_copy"
        ],
        "load_event_unsubscribed_object_model": [
            "extracted_and_audit_files_copy"
        ],
        "extracted_and_audit_files_copy": [
            "save_status_of_the_dag"
        ]
    },
    "load_event_bounced_object_model": {
        "kafka_to_s3": {
            "spark_engine": {
                "spark_run_mode": "high",
                "scripts": [
                    "event_bounced_kafka_to_s3.sql"
                ],
                "input_details": [
                    {
                        "conn_name": "__KAFKA_DAS_SINK_Contact_Event__",
                        "sql_table_reference": "kafka_source",
                        "data_source_name": "marketing-contact-event-bounced-avro"
                    }
                ],
                "output_details": [
                    {
                        "conn_name": "__S3_CONTACT_EVENT_DATA_CSV_SINK__",
                        "sql_table_reference": "event_bounced_data_extract"
                    },
                    {
                        "conn_name": "__S3_CONTACT_EVENT_AUDIT_CSV_SINK__",
                        "sql_table_reference": "event_bounced_final_count"
                    }
                ]
            }
        }
    },
    "load_event_clicked_object_model": {
        "kafka_to_s3": {
            "spark_engine": {
                "spark_run_mode": "high",
                "scripts": [
                    "event_clicked_kafka_to_s3.sql"
                ],
                "input_details": [
                    {
                        "conn_name": "__KAFKA_DAS_SINK_Contact_Event__",
                        "sql_table_reference": "kafka_source",
                        "data_source_name": "marketing-contact-event-clicked-avro"
                    }
                ],
                "output_details": [
                    {
                        "conn_name": "__S3_CONTACT_EVENT_DATA_CSV_SINK__",
                        "sql_table_reference": "event_clicked_data_extract"
                    },
                    {
                        "conn_name": "__S3_CONTACT_EVENT_AUDIT_CSV_SINK__",
                        "sql_table_reference": "event_clicked_final_count"
                    }
                ]
            }
        }
    },
    "load_event_opened_object_model": {
        "kafka_to_s3": {
            "spark_engine": {
                "spark_run_mode": "high",
                "scripts": [
                    "event_opened_kafka_to_s3.sql"
                ],
                "input_details": [
                    {
                        "conn_name": "__KAFKA_DAS_SINK_Contact_Event__",
                        "sql_table_reference": "kafka_source",
                        "data_source_name": "marketing-contact-event-opened-avro"
                    }
                ],
                "output_details": [
                    {
                        "conn_name": "__S3_CONTACT_EVENT_DATA_CSV_SINK__",
                        "sql_table_reference": "event_opened_data_extract"
                    },
                    {
                        "conn_name": "__S3_CONTACT_EVENT_AUDIT_CSV_SINK__",
                        "sql_table_reference": "event_opened_final_count"
                    }
                ]
            }
        }
    },
    "load_event_sent_object_model": {
        "kafka_to_s3": {
            "spark_engine": {
                "spark_run_mode": "high",
                "scripts": [
                    "event_sent_kafka_to_s3.sql"
                ],
                "input_details": [
                    {
                        "conn_name": "__KAFKA_DAS_SINK_Contact_Event__",
                        "sql_table_reference": "kafka_source",
                        "data_source_name": "marketing-contact-event-sent-avro"
                    }
                ],
                "output_details": [
                    {
                        "conn_name": "__S3_CONTACT_EVENT_DATA_CSV_SINK__",
                        "sql_table_reference": "event_sent_data_extract"
                    },
                    {
                        "conn_name": "__S3_CONTACT_EVENT_AUDIT_CSV_SINK__",
                        "sql_table_reference": "event_sent_final_count"
                    }
                ]
            }
        }
    },
    "load_event_unsubscribed_object_model": {
        "kafka_to_s3": {
            "spark_engine": {
                "spark_run_mode": "high",
                "scripts": [
                    "event_unsubscribed_kafka_to_s3.sql"
                ],
                "input_details": [
                    {
                        "conn_name": "__KAFKA_DAS_SINK_Contact_Event__",
                        "sql_table_reference": "kafka_source",
                        "data_source_name": "marketing-contact-event-unsubscribed-avro"
                    }
                ],
                "output_details": [
                    {
                        "conn_name": "__S3_CONTACT_EVENT_DATA_CSV_SINK__",
                        "sql_table_reference": "event_unsubscribed_data_extract"
                    },
                    {
                        "conn_name": "__S3_CONTACT_EVENT_AUDIT_CSV_SINK__",
                        "sql_table_reference": "event_unsubscribed_final_count"
                    }
                ]
            }
        }
    },
    "extracted_and_audit_files_copy": {
        "to_s3_path_folder": {
            "python_executor": {
                "module": "python/utils",
                "version": "1.3.18",
                "args": [
                    "python/utils/src/bulk_s3_copy.py",
                    "--s3_source_bucket_env_name",
                    "S3_MKTG_BUCKET",
                    "--s3_target_bucket_env_name",
                    "S3_MKTG_BUCKET",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/data/contact_event/event_bounced_data_extract/', 'target': 'isf/data/contact_event/eventBounced/year=<year>/month=<month>/day=<day>/'}",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/data/contact_event/event_clicked_data_extract/', 'target': 'isf/data/contact_event/eventClicked/year=<year>/month=<month>/day=<day>/'}",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/data/contact_event/event_opened_data_extract/', 'target': 'isf/data/contact_event/eventOpened/year=<year>/month=<month>/day=<day>/'}",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/data/contact_event/event_sent_data_extract/', 'target': 'isf/data/contact_event/eventSent/year=<year>/month=<month>/day=<day>/'}",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/data/contact_event/event_unsubscribed_data_extract/', 'target': 'isf/data/contact_event/eventUnsubscribed/year=<year>/month=<month>/day=<day>/'}",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/audit/contact_event/event_bounced_final_count/', 'target': 'isf/audit/contact_event/eventBounced/year=<year>/month=<month>/day=<day>/'}",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/audit/contact_event/event_clicked_final_count/', 'target': 'isf/audit/contact_event/eventClicked/year=<year>/month=<month>/day=<day>/'}",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/audit/contact_event/event_opened_final_count/', 'target': 'isf/audit/contact_event/eventOpened/year=<year>/month=<month>/day=<day>/'}",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/audit/contact_event/event_sent_final_count/', 'target': 'isf/audit/contact_event/eventSent/year=<year>/month=<month>/day=<day>/'}",
                    "--source_to_target_path_pair",
                    "{'source': 'isf/audit/contact_event/event_unsubscribed_final_count/', 'target': 'isf/audit/contact_event/eventUnsubscribed/year=<year>/month=<month>/day=<day>/'}",
                    "--base_date_iso_env_name",
                    "DAG_EXECUTION_DATE"
                ]
            },
            "macros": {
                "DAG_EXECUTION_DATE": "execution_date"
            }
        }
    }
}