{
    "dag_id": "icon_lounge",
    "dag_schedule": "00 12 * * 3",
    "prod_email_on_failure": "nap-marketing@nordstrom.pagerduty.com",
    "nonprod_email_on_failure": "yu-lin.chou@nordstrom.com",
    "stages": [
        "read_s3_to_teradata",
        "s3_bucket_move_files"
    ],
    "stage_dependencies": {
        "read_s3_to_teradata": [
            "s3_bucket_move_files"
        ]
    },
    "read_s3_to_teradata": {
        "job_0": {
            "spark_engine": {
                "spark_run_mode": "low",
                "scripts": [
                    "s3_to_stg.sql"
                ],
                "input_details": [
                    {
                        "conn_name": "__S3_ICON_LOUNGE_DATA_CSV__",
                        "sql_table_reference": "s3_read_icon_lounge_tbl"
                    }
                ],
                "output_details": [
                    {
                        "conn_name": "__Teradata_ICON_LOUNGE_Source__",
                        "sql_table_reference": "write_teradata_icon_lounge_tbl",
                        "data_source_name": "ICON_LOUNGE_STG"
                    }
                ]
            }
        },
        "job_1": {
            "teradata_engine": {
                "input_details": [
                    {
                        "conn_name": "__Teradata_NAP_Source__",
                        "scripts": [
                            "stg_to_fct.sql"
                        ]
                    }
                ]
            }
        }
    },
    "s3_bucket_move_files": {
        "to_s3_path_folders": {
            "python_executor": {
                "module": "python/utils",
                "version": "1.3.18",
                "args": [
                    "python/utils/src/bulk_s3_copy.py",
                    "--s3_source_bucket_env_name",
                    "S3_ICON_LOUNGE_BUCKET",
                    "--s3_target_bucket_env_name",
                    "S3_ICON_LOUNGE_BUCKET",
                    "--source_to_target_path_pair",
                    "{'source': 'tokenized/', 'target': 'backup/'}"
                ]
            }
        }
    },
    "s3_delete": {
        "python_executor": {
            "module": "python/utils",
            "version": "1.3.19",
            "args": [
                "python/utils/src/s3_delete.py",
                "--s3_source_bucket_env_name",
                "S3_ICON_LOUNGE_BUCKET",
                "--s3_source_prefix_format",
                "tokenized/"
            ]
        }
    }
}