-- mandatory Query Band part
SET QUERY_BAND = 'App_ID=app07420; DAG_ID=payment_settlement_result_teradata; Task_Name=teradata_stg_to_teradata_fct_job;' -- noqa
FOR SESSION VOLATILE;

END TRANSACTION;

-- Create temporary tables for selecting distinct records by 'settlementID'.
CREATE MULTISET VOLATILE TABLE SETTLEMENT_RESULT_STG_TEMP AS (
    SELECT DISTINCT *
    FROM {db_env}_NAP_STG.PAYMENT_SETTLEMENT_RESULT_LDG
    QUALIFY row_number() OVER (PARTITION BY SETTLEMENT_RESULT_RECEIVED_ID ORDER BY TRANSACTION_TIMESTAMP DESC) = 1
) WITH DATA PRIMARY INDEX (SETTLEMENT_RESULT_RECEIVED_ID) ON COMMIT PRESERVE ROWS;

END TRANSACTION;

-- Insert or update if exist
MERGE INTO {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT AS PSR
USING SETTLEMENT_RESULT_STG_TEMP AS SRC
    ON (
        SRC.SETTLEMENT_RESULT_RECEIVED_ID = PSR.SETTLEMENT_RESULT_RECEIVED_ID
        AND cast(
            concat(SRC.TRANSACTION_TIMESTAMP, '+00:00') AS TIMESTAMP(6) WITH TIME ZONE
        ) = PSR.TRANSACTION_TIMESTAMP
    )
WHEN MATCHED THEN
    UPDATE
        SET
            DW_SYS_UPDT_TMSTP = current_timestamp(0),
            CHANNEL_COUNTRY = SRC.CHANNEL_COUNTRY,
            CHANNEL_BRAND = SRC.CHANNEL_BRAND,
            SELLING_CHANNEL = SRC.SELLING_CHANNEL,
            ACQUIRER = SRC.ACQUIRER,
            SETTLEMENT_AMOUNT_CURRENCY_CODE
            = SRC.SETTLEMENT_AMOUNT_CURRENCY_CODE,
            SETTLEMENT_AMOUNT = SRC.SETTLEMENT_AMOUNT,
            STORE_NUMBER = SRC.STORE_NUMBER,
            PROCESSING_DATE = SRC.PROCESSING_DATE,
            TRANSACTION_TIME_ZONE_OFFSET_MINUTES
            = SRC.TRANSACTION_TIME_ZONE_OFFSET_MINUTES,
            TRANSACTION_TYPE = SRC.TRANSACTION_TYPE,
            TENDER_TYPE = SRC.TENDER_TYPE
WHEN NOT MATCHED THEN
    INSERT (
        DW_SYS_LOAD_TMSTP,
        DW_SYS_UPDT_TMSTP,
        SETTLEMENT_RESULT_RECEIVED_ID,
        CHANNEL_COUNTRY,
        CHANNEL_BRAND,
        SELLING_CHANNEL,
        ACQUIRER,
        SETTLEMENT_AMOUNT_CURRENCY_CODE,
        SETTLEMENT_AMOUNT,
        STORE_NUMBER,
        PROCESSING_DATE,
        TRANSACTION_TIMESTAMP,
        TRANSACTION_TIME_ZONE_OFFSET_MINUTES,
        TRANSACTION_TYPE,
        TENDER_TYPE
    )
        VALUES (
            current_timestamp(0),
            current_timestamp(0),
            SRC.SETTLEMENT_RESULT_RECEIVED_ID,
            SRC.CHANNEL_COUNTRY,
            SRC.CHANNEL_BRAND,
            SRC.SELLING_CHANNEL,
            SRC.ACQUIRER,
            SRC.SETTLEMENT_AMOUNT_CURRENCY_CODE,
            SRC.SETTLEMENT_AMOUNT,
            SRC.STORE_NUMBER,
            SRC.PROCESSING_DATE,
            cast(concat(SRC.TRANSACTION_TIMESTAMP, '+00:00') AS TIMESTAMP(6) WITH TIME ZONE),
            SRC.TRANSACTION_TIME_ZONE_OFFSET_MINUTES,
            SRC.TRANSACTION_TYPE,
            SRC.TENDER_TYPE
        );

MERGE INTO {db_env}_NAP_BASE_VWS.PAYMENT_BANK_CARD_SETTLEMENT_RESULT_FACT AS PBC
USING SETTLEMENT_RESULT_STG_TEMP AS SRC
    ON (SRC.SETTLEMENT_RESULT_RECEIVED_ID = PBC.SETTLEMENT_RESULT_RECEIVED_ID)
WHEN MATCHED THEN
    UPDATE
        SET
            DW_SYS_UPDT_TMSTP = current_timestamp(0),
            ACQUIRER_MERCHANT_IDENTIFIER = SRC.ACQUIRER_MERCHANT_IDENTIFIER,
            BANK_CARD_AUTHORIZATION_SOURCE = SRC.BANK_CARD_AUTHORIZATION_SOURCE,
            AUTHORIZATION_CODE = SRC.AUTHORIZATION_CODE,
            VENDOR_SETTLEMENT_CODE = SRC.VENDOR_SETTLEMENT_CODE,
            EXPIRATION_DATE_MONTH = SRC.EXPIRATION_DATE_MONTH,
            EXPIRATION_DATE_YEAR = cast(to_number(from_bytes(SRC.EXPIRATION_DATE_YEAR, 'ASCII')) AS SMALLINT),
            INTERCHANGE_CODE = SRC.INTERCHANGE_CODE,
            INTERCHANGE_AMOUNT_CURRENCY_CODE
            = SRC.INTERCHANGE_AMOUNT_CURRENCY_CODE,
            INTERCHANGE_AMOUNT = SRC.INTERCHANGE_AMOUNT,
            MERCHANT_CATEGORY_CODE = SRC.MERCHANT_CATEGORY_CODE,
            ENTRY_MODE = SRC.ENTRY_MODE,
            TOKEN_VALUE = SRC.TOKEN_VALUE,
            TOKEN_AUTHORITY = SRC.TOKEN_AUTHORITY,
            TOKEN_DATA_CLASSIFICATION = SRC.TOKEN_DATA_CLASSIFICATION,
            TOKEN_TYPE = SRC.TOKEN_TYPE,
            TRANSACTION_MATCH_IDENTIFIER = SRC.TRANSACTION_MATCH_IDENTIFIER,
            CARD_TYPE = SRC.CARD_TYPE,
            CARD_SUBTYPE = SRC.CARD_SUBTYPE,
            TOKEN_REQUESTOR_ID = SRC.TOKEN_REQUESTOR_ID,
            CARD_PRODUCT_TYPE = SRC.CARD_PRODUCT_TYPE,
            INTERCHANGE_ADJUSTMENT_AMOUNT_CURRENCY_CODE
            = SRC.INTERCHANGE_ADJUSTMENT_AMOUNT_CURRENCY_CODE,
            INTERCHANGE_ADJUSTMENT_AMOUNT = SRC.INTERCHANGE_ADJUSTMENT_AMOUNT,
            INTERCHANGE_ADJUSTMENT_REASON = SRC.INTERCHANGE_ADJUSTMENT_REASON,
            EMV_TRANSACTION_INDICATOR = SRC.EMV_TRANSACTION_INDICATOR,
            NETWORK_REFERENCE_NUMBER = SRC.NETWORK_REFERENCE_NUMBER,
            VISA_TRANSACTION_ID = SRC.VISA_TRANSACTION_ID,
            MASTERCARD_BANK_NET_REFERENCE_NUMBER
            = SRC.MASTERCARD_BANK_NET_REFERENCE_NUMBER,
            TERMINAL_ID = SRC.TERMINAL_ID
WHEN NOT MATCHED THEN
    INSERT (
        DW_SYS_LOAD_TMSTP,
        DW_SYS_UPDT_TMSTP,
        SETTLEMENT_RESULT_RECEIVED_ID,
        ACQUIRER_MERCHANT_IDENTIFIER,
        BANK_CARD_AUTHORIZATION_SOURCE,
        AUTHORIZATION_CODE,
        VENDOR_SETTLEMENT_CODE,
        EXPIRATION_DATE_MONTH,
        EXPIRATION_DATE_YEAR,
        INTERCHANGE_CODE,
        INTERCHANGE_AMOUNT_CURRENCY_CODE,
        INTERCHANGE_AMOUNT,
        MERCHANT_CATEGORY_CODE,
        ENTRY_MODE,
        TOKEN_VALUE,
        TOKEN_AUTHORITY,
        TOKEN_DATA_CLASSIFICATION,
        TOKEN_TYPE,
        TRANSACTION_MATCH_IDENTIFIER,
        CARD_TYPE,
        CARD_SUBTYPE,
        TOKEN_REQUESTOR_ID,
        CARD_PRODUCT_TYPE,
        INTERCHANGE_ADJUSTMENT_AMOUNT_CURRENCY_CODE,
        INTERCHANGE_ADJUSTMENT_AMOUNT,
        INTERCHANGE_ADJUSTMENT_REASON,
        EMV_TRANSACTION_INDICATOR,
        NETWORK_REFERENCE_NUMBER,
        VISA_TRANSACTION_ID,
        MASTERCARD_BANK_NET_REFERENCE_NUMBER,
        TERMINAL_ID
    )
        VALUES (
            current_timestamp(0),
            current_timestamp(0),
            SRC.SETTLEMENT_RESULT_RECEIVED_ID,
            SRC.ACQUIRER_MERCHANT_IDENTIFIER,
            SRC.BANK_CARD_AUTHORIZATION_SOURCE,
            SRC.AUTHORIZATION_CODE,
            SRC.VENDOR_SETTLEMENT_CODE,
            SRC.EXPIRATION_DATE_MONTH,
            cast(to_number(from_bytes(SRC.EXPIRATION_DATE_YEAR, 'ASCII')) AS SMALLINT),
            SRC.INTERCHANGE_CODE,
            SRC.INTERCHANGE_AMOUNT_CURRENCY_CODE,
            SRC.INTERCHANGE_AMOUNT,
            SRC.MERCHANT_CATEGORY_CODE,
            SRC.ENTRY_MODE,
            SRC.TOKEN_VALUE,
            SRC.TOKEN_AUTHORITY,
            SRC.TOKEN_DATA_CLASSIFICATION,
            SRC.TOKEN_TYPE,
            SRC.TRANSACTION_MATCH_IDENTIFIER,
            SRC.CARD_TYPE,
            SRC.CARD_SUBTYPE,
            SRC.TOKEN_REQUESTOR_ID,
            SRC.CARD_PRODUCT_TYPE,
            SRC.INTERCHANGE_ADJUSTMENT_AMOUNT_CURRENCY_CODE,
            SRC.INTERCHANGE_ADJUSTMENT_AMOUNT,
            SRC.INTERCHANGE_ADJUSTMENT_REASON,
            SRC.EMV_TRANSACTION_INDICATOR,
            SRC.NETWORK_REFERENCE_NUMBER,
            SRC.VISA_TRANSACTION_ID,
            SRC.MASTERCARD_BANK_NET_REFERENCE_NUMBER,
            SRC.TERMINAL_ID
        );

-- Update PAYMENT_ID_SETTLEMENT_INTENT column
UPDATE {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT
FROM (
SELECT
    A.SETTLEMENT_RESULT_RECEIVED_ID,
    B.VENDOR_SETTLEMENT_CODE,
    B.TOKEN_VALUE,
    A.SETTLEMENT_AMOUNT
FROM {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT A
INNER JOIN {db_env}_NAP_BASE_VWS.PAYMENT_BANK_CARD_SETTLEMENT_RESULT_FACT B
ON A.SETTLEMENT_RESULT_RECEIVED_ID = B.SETTLEMENT_RESULT_RECEIVED_ID
WHERE A.SETTLEMENT_RESULT_RECEIVED_ID IN
(SELECT DISTINCT SETTLEMENT_RESULT_RECEIVED_ID
    FROM {db_env}_NAP_STG.PAYMENT_SETTLEMENT_RESULT_LDG)
) AS C
SET PAYMENT_ID_SETTLEMENT_INTENT = hash_sha256(concat(
                coalesce(trim(C.VENDOR_SETTLEMENT_CODE), ''),
                coalesce(trim(C.TOKEN_VALUE), ''),
                coalesce(trim(cast(cast(C.SETTLEMENT_AMOUNT AS DECIMAL(12, 2)) AS VARCHAR(50))), '')
                ))
WHERE {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT.SETTLEMENT_RESULT_RECEIVED_ID = C.SETTLEMENT_RESULT_RECEIVED_ID;

-- Update PAYMENT_ID_AUTHORIZATION_RESULT column
UPDATE {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT
FROM (
SELECT
    A.SETTLEMENT_RESULT_RECEIVED_ID,
    A.TENDER_TYPE,
    A.STORE_NUMBER,
    B.TOKEN_VALUE,
    B.ACQUIRER_MERCHANT_IDENTIFIER,
    A.TRANSACTION_TIMESTAMP,
    B.CARD_TYPE
FROM {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT A
INNER JOIN {db_env}_NAP_BASE_VWS.PAYMENT_BANK_CARD_SETTLEMENT_RESULT_FACT B
ON A.SETTLEMENT_RESULT_RECEIVED_ID = B.SETTLEMENT_RESULT_RECEIVED_ID
WHERE A.SETTLEMENT_RESULT_RECEIVED_ID IN
(SELECT DISTINCT SETTLEMENT_RESULT_RECEIVED_ID
    FROM {db_env}_NAP_STG.PAYMENT_SETTLEMENT_RESULT_LDG)
) AS C
SET PAYMENT_ID_AUTHORIZATION_RESULT = hash_sha256(concat(
                coalesce(trim(C.TENDER_TYPE), ''),
                coalesce(trim(C.STORE_NUMBER), ''),
                coalesce(trim(C.TOKEN_VALUE), ''),
                coalesce(trim(C.ACQUIRER_MERCHANT_IDENTIFIER), ''),
                coalesce(trim(to_char(C.TRANSACTION_TIMESTAMP)), ''),
                coalesce(trim(C.CARD_TYPE), '')
                ))
WHERE {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT.SETTLEMENT_RESULT_RECEIVED_ID = C.SETTLEMENT_RESULT_RECEIVED_ID;


-- Remove records from temporary tables
DELETE FROM {db_env}_NAP_STG.PAYMENT_SETTLEMENT_RESULT_LDG;

SET QUERY_BAND = NONE FOR SESSION; -- noqa

END TRANSACTION;
