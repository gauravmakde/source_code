-- mandatory Query Band part
SET QUERY_BAND = 'App_ID=app07420; DAG_ID=authorization_result_hashkey_backfill_teradata;Task_Name=job_insert_update;' -- noqa
FOR SESSION VOLATILE;

END TRANSACTION;

UPDATE PREPROD_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT
FROM (
SELECT
    A.AUTHORIZATION_RESULT_ID,
    B.AUTHORIZATION_CODE,
    A.PROCESSING_DATE,
    B.TOKEN_VALUE,
    A.AUTHORIZATION_AMOUNT
FROM PREPROD_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT A
INNER JOIN PREPROD_NAP_BASE_VWS.PAYMENT_BANK_CARD_AUTHORIZATION_RESULT_FACT B
ON A.AUTHORIZATION_RESULT_ID = B.AUTHORIZATION_RESULT_ID
) AS C
SET PAYMENT_ID_AUTHORIZATION = HASH_SHA256(CONCAT(
                COALESCE(TRIM(C.AUTHORIZATION_CODE), ''),
                COALESCE(TRIM(C.TOKEN_VALUE), ''),
                COALESCE(TRIM(CAST(CAST(C.AUTHORIZATION_AMOUNT AS DECIMAL(12, 2)) AS VARCHAR(50))), '')
                ))
WHERE PREPROD_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT.AUTHORIZATION_RESULT_ID = C.AUTHORIZATION_RESULT_ID;

UPDATE PREPROD_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT
FROM (
SELECT
    A.AUTHORIZATION_RESULT_ID,
    A.TENDER_TYPE,
    A.STORE_NUMBER,
    B.TOKEN_VALUE,
    B.ACQUIRER_MERCHANT_IDENTIFIER,
    A.TRANSACTION_TIMESTAMP,
    B.CARD_TYPE
FROM PREPROD_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT A
INNER JOIN PREPROD_NAP_BASE_VWS.PAYMENT_BANK_CARD_AUTHORIZATION_RESULT_FACT B
ON A.AUTHORIZATION_RESULT_ID = B.AUTHORIZATION_RESULT_ID
) AS C
SET PAYMENT_ID_SETTLEMENT_RESULT = HASH_SHA256(CONCAT(
                COALESCE(TRIM(C.TENDER_TYPE), ''),
                COALESCE(TRIM(C.STORE_NUMBER), ''),
                COALESCE(TRIM(C.TOKEN_VALUE), ''),
                COALESCE(TRIM(C.ACQUIRER_MERCHANT_IDENTIFIER), ''),
                COALESCE(TRIM(TO_CHAR(C.TRANSACTION_TIMESTAMP)), ''),
                COALESCE(TRIM(C.CARD_TYPE), '')
                ))
WHERE PREPROD_NAP_BASE_VWS.PAYMENT_AUTHORIZATION_RESULT_FACT.AUTHORIZATION_RESULT_ID = C.AUTHORIZATION_RESULT_ID;


SET QUERY_BAND = NONE FOR SESSION; -- noqa

END TRANSACTION;
