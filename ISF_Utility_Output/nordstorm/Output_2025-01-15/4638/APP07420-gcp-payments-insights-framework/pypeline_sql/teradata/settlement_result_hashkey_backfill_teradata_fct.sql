-- mandatory Query Band part
SET QUERY_BAND = 'App_ID=app07420; DAG_ID=settlement_result_hashkey_backfill_teradata;Task_Name=job_insert_update;' -- noqa
FOR SESSION VOLATILE;

END TRANSACTION;

UPDATE {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT
FROM (
SELECT
    A.SETTLEMENT_RESULT_RECEIVED_ID,
    B.VENDOR_SETTLEMENT_CODE,
    A.PROCESSING_DATE,
    B.TOKEN_VALUE,
    A.SETTLEMENT_AMOUNT
FROM {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT A
INNER JOIN {db_env}_NAP_BASE_VWS.PAYMENT_BANK_CARD_SETTLEMENT_RESULT_FACT B
ON A.SETTLEMENT_RESULT_RECEIVED_ID = B.SETTLEMENT_RESULT_RECEIVED_ID
) AS C
SET PAYMENT_ID_SETTLEMENT_INTENT = HASH_SHA256(CONCAT(
                COALESCE(TRIM(C.VENDOR_SETTLEMENT_CODE), ''),
                COALESCE(TRIM(C.TOKEN_VALUE), ''),
                COALESCE(TRIM(CAST(CAST(C.SETTLEMENT_AMOUNT AS DECIMAL(12, 2)) AS VARCHAR(50))), '')
                ))
WHERE {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT.SETTLEMENT_RESULT_RECEIVED_ID = C.SETTLEMENT_RESULT_RECEIVED_ID;

UPDATE {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT
FROM (
SELECT
    A.SETTLEMENT_RESULT_RECEIVED_ID,
    A.TENDER_TYPE,
    A.STORE_NUMBER,
    B.TOKEN_VALUE,
    B.ACQUIRER_MERCHANT_IDENTIFIER,
    A.TRANSACTION_TIMESTAMP,
    B.CARD_TYPE
FROM {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT A
INNER JOIN {db_env}_NAP_BASE_VWS.PAYMENT_BANK_CARD_SETTLEMENT_RESULT_FACT B
ON A.SETTLEMENT_RESULT_RECEIVED_ID = B.SETTLEMENT_RESULT_RECEIVED_ID
) AS C
SET PAYMENT_ID_AUTHORIZATION_RESULT = HASH_SHA256(CONCAT(
                COALESCE(TRIM(C.TENDER_TYPE), ''),
                COALESCE(TRIM(C.STORE_NUMBER), ''),
                COALESCE(TRIM(C.TOKEN_VALUE), ''),
                COALESCE(TRIM(C.ACQUIRER_MERCHANT_IDENTIFIER), ''),
                COALESCE(TRIM(TO_CHAR(C.TRANSACTION_TIMESTAMP)), ''),
                COALESCE(TRIM(C.CARD_TYPE), '')
                ))
WHERE {db_env}_NAP_BASE_VWS.PAYMENT_SETTLEMENT_RESULT_FACT.SETTLEMENT_RESULT_RECEIVED_ID = C.SETTLEMENT_RESULT_RECEIVED_ID;


SET QUERY_BAND = NONE FOR SESSION; -- noqa

END TRANSACTION;
