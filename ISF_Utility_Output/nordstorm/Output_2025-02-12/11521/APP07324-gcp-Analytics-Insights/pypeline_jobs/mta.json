{
    "dag_id": "mta",
    "dag_schedule": "35 3 * * *",
    "timezone": "US/Pacific",
    "dag_sla_minutes": "150",
    "prod_email_on_failure": "app08047-mta@nordstrom.pagerduty.com",
    "nonprod_email_on_failure": "ricky.medrano@nordstrom.com",
    "dependencies": {
        "upstream": {
            "other_app_id": {
                "dags": [
                    {
                        "external_dag_id": "funnel_events_authenticated_17168_styling_styling_insights_kpi",
                        "conn_id": "okta-conn-to-app05039",
                        "retries": 3,
                        "poke_interval": 120,
                        "timeout": 3600
                    },
                    {
                        "external_dag_id": "funnel_events_arrived_17168_styling_styling_insights_kpi",
                        "conn_id": "okta-conn-to-app05039",
                        "retries": 3,
                        "poke_interval": 120,
                        "timeout": 3600
                    },
                    {
                        "external_dag_id": "funnel_events_order_submitted_17168_styling_styling_insights_kpi",
                        "conn_id": "okta-conn-to-app05039",
                        "retries": 3,
                        "poke_interval": 120,
                        "timeout": 3600
                    },
                    {
                        "external_dag_id": "funnel_events_order_cancelled_17168_styling_styling_insights_kpi",
                        "conn_id": "okta-conn-to-app05039",
                        "retries": 3,
                        "poke_interval": 120,
                        "timeout": 3600
                    },
                    {
                        "external_dag_id": "ERTM_OBJECTMODEL_TO_ORC_LOAD_NSK",
                        "conn_id": "okta-conn-to-app07465",
                        "retries": 3,
                        "poke_interval": 120,
                        "timeout": 3600
                    }
                ]
            }
        }
    },
    "stages": [
        "check_file_sensor",
        "mta_touches",
        "mta_last_touch",
        "mta_acp_scoring_fact",
        "mta_utm_demand_agg"
    ],
    "stage_dependencies": {
        "check_file_sensor": [
            "mta_touches"
        ],
        "mta_touches": [
            "mta_last_touch",
            "mta_acp_scoring_fact"
        ],
        "mta_acp_scoring_fact": [
            "mta_utm_demand_agg"
        ]
    },
    "sql_env_vars": {
        "start_date": "current_date()-5",
        "end_date": "current_date()-1"
    },
    "check_file_sensor": {
        "check_cpa": {
            "python_executor": {
                "module": "python/s3_file_sensor",
                "version": "0.3.0",
                "k8s_cpu_limit": 2,
                "k8s_cpu_request": 1,
                "k8s_memory_limit": "6Gi",
                "k8s_memory_request": "2Gi",
                "args": [
                    "python/s3_file_sensor/main.py",
                    "--function",
                    "timestamp_check",
                    "--bucket_nonprod",
                    "",
                    "--key_nonprod",
                    "",
                    "--bucket_prod",
                    "tf-das-cust-prod-profile-presentation",
                    "--key_prod",
                    "customer_profile_association/_SUCCESS",
                    "--max_retry_minutes",
                    "60"
                ]
            }
        }
    },
    "mta_touches": {
        "job0_hive_output": {
            "spark_engine": {
                "spark_run_mode": "medium_no_broadcast",
                "retries": "0",
                "pause_idle_cluster_termination": "before_app",
                "scripts": [
                    "mta/mta_touches.sql"
                ],
                "input_details": [],
                "output_details": []
            }
        },
        "job1_tpt_job_insert": {
            "teradata_engine": {
                "input_details": [
                    {
                        "conn_name": "TERADATA_SOURCE_MTA",
                        "scripts": [
                            "mta/mta_tpt_job_insert.sql"
                        ]
                    }
                ]
            }
        }
    },
    "mta_last_touch": {
        "job0_create_ldg": {
            "teradata_engine": {
                "input_details": [
                    {
                        "conn_name": "TERADATA_SOURCE_MTA",
                        "scripts": [
                            "mta/ddl/ddl_mta_last_touch_ldg.sql"
                        ]
                    }
                ]
            }
        },
        "job1_hive_to_csv": {
            "spark_engine": {
                "spark_run_mode": "medium",
                "retries": "0",
                "scripts": [
                    "mta/mta_last_touch_load.sql"
                ],
                "input_details": [],
                "output_details": [
                    {
                        "conn_name": "TPT_CSV_OUTPUT",
                        "sql_table_reference": "mta_last_touch_ldg_output"
                    }
                ]
            }
        },
        "job2_tpt_mta_last_touch": {
            "tpt_engine": {
                "retries": "0",
                "input_details": [
                    {
                        "conn_name": "TPT_MTA",
                        "delimiter": "1F",
                        "table_name": "mta_last_touch_ldg",
                        "s3_file_path": "s3://{tpt_path}/mta_last_touch_ldg_output/*.csv.gz",
                        "job_name": "mta_mta_last_touch_ldg"
                    }
                ],
                "output_details": []
            }
        },
        "job3_update_t2": {
            "teradata_engine": {
                "input_details": [
                    {
                        "conn_name": "TERADATA_SOURCE_MTA",
                        "scripts": [
                            "mta/mta_last_touch.sql"
                        ]
                    }
                ]
            }
        }
    },
    "mta_acp_scoring_fact": {
        "job0_create_ldg": {
            "teradata_engine": {
                "input_details": [
                    {
                        "conn_name": "TERADATA_SOURCE_MTA",
                        "scripts": [
                            "mta/ddl/ddl_mta_acp_scoring_fact_ldg.sql"
                        ]
                    }
                ]
            }
        },
        "job1_hive_to_csv": {
            "spark_engine": {
                "spark_run_mode": "medium",
                "retries": "0",
                "scripts": [
                    "mta/mta_acp_scoring.sql"
                ],
                "input_details": [],
                "output_details": [
                    {
                        "conn_name": "TPT_CSV_OUTPUT",
                        "sql_table_reference": "mta_acp_scoring_fact_ldg_output"
                    }
                ]
            }
        },
        "job2_tpt_mta_acp_scoring": {
            "tpt_engine": {
                "retries": "0",
                "input_details": [
                    {
                        "conn_name": "TPT_MTA",
                        "delimiter": "1F",
                        "table_name": "mta_acp_scoring_fact_ldg",
                        "s3_file_path": "s3://{tpt_path}/mta_acp_scoring_fact_ldg_output/*.csv.gz",
                        "job_name": "mta_mta_acp_scoring_fact_ldg"
                    }
                ],
                "output_details": []
            }
        },
        "job3_update_t2": {
            "teradata_engine": {
                "input_details": [
                    {
                        "conn_name": "TERADATA_SOURCE_MTA",
                        "scripts": [
                            "mta/mta_acp_scoring_fact.sql"
                        ]
                    }
                ]
            }
        }
    },
    "mta_utm_demand_agg": {
        "job0_update_t2": {
            "teradata_engine": {
                "input_details": [
                    {
                        "conn_name": "TERADATA_SOURCE_MTA",
                        "scripts": [
                            "mta/mta_utm_demand_agg.sql"
                        ]
                    }
                ]
            }
        }
    }
}